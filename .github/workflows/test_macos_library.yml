name: Build and Repair Wheel

on:
  push:
    branches:
      - update_workflow

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          pip install --upgrade pip
          pip install cibuildwheel delocate

      - name: Build the wheel for macOS
        env:
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: "delocate-wheel --ignore-missing-dependencies --require-archs {delocate_archs} -w {dest_dir} -v {wheel} --verbose"
        run: |
          cibuildwheel --platform macos --output-dir wheelhouse

      - name: Repair the wheel by including libdb2.dylib
        run: |
          # If libdb2.dylib is installed or manually copied, you can use delocate to bundle it
          delocate-wheel --verbose --install-path /usr/local/lib wheelhouse/*.whl

      - name: Verify the wheel
        run: |
          pip install --no-index --find-links=wheelhouse ibm_db
          python -c "import ibm_db"
